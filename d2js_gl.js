/*
 * D2JS
 * Copyright (C) SatisKia. All rights reserved.
 */
(function(n,t){function e(n,t,i,u,f,e,o,s,h){var c;if(this._p=n,this._index=t,this._tex_index=i,this._mat=new Array(16),u!=null)for(c=0;c<16;c++)this._mat[c]=u[c];if(this._trans=f>=0?f:n.transparency(),this._distance=0,e){var l=o-r.positionX(),a=s-r.positionY(),v=h-r.positionZ();this._distance=r.distance(l,a,v)}}function w(n){var t;if(this._proj_mat=new Array(16),n!=null)for(t=0;t<16;t++)this._proj_mat[t]=n[t];this._draw=[]}function ct(){var n=f.createElement(h),t=n.getContext(c);return t!=null}function lt(n,e,o){var s,h;e==t&&(e="");o==t&&(o=!1);removeMouseEvent();s=setCanvas(f.getElementById(n));i=o?s.getContext(c,{stencil:!0}):s.getContext(c);initLock();e.length>0&&(u=s,s=setCanvas(f.getElementById(e)),h=setContext(s.getContext(l)),s.width=u.width,s.height=u.height,h.textAlign=rt,h.textBaseline=ut,setGraphics(new _Graphics));addMouseEvent();r=new y;init3D(i,r)?(u!=null&&init2D(getGraphics()),setRepaintFunc(b)):killTimer()}function a(){return u==null?getCurrent():u}function at(){return i}function vt(n,t){a().width=n;a().height=t}function k(n,t){var r=i.createShader(n);return(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS))?(i.deleteShader(r),null):r}function d(n,t){var u=k(i.VERTEX_SHADER,n),f=k(i.FRAGMENT_SHADER,t),r=i.createProgram();return(i.attachShader(r,u),i.attachShader(r,f),i.linkProgram(r),!i.getProgramParameter(r,i.LINK_STATUS))?null:r}function v(n,t,i){this._glp=new s;this._glp.setType(0);this._glp.setDepth(t);this._id=n;this._lighting=i;this._material_num=0;this._material_texture=null;this._material_diffuse=null;this._material_ambient=null;this._material_emission=null;this._material_specular=null;this._material_shininess=null;this._object_num=0;this._coord=null;this._normal=null;this._color=null;this._map=null;this._strip_num=0;this._strip_material=null;this._strip_coord=null;this._strip_normal=null;this._strip_color=null;this._strip_map=null;this._strip_len=null;this._strip=null;this._strip_tx=null;this._strip_ty=null;this._strip_tz=null;this._strip_or=null;this._strip_ox=null;this._strip_oy=null;this._strip_oz=null;this._texture_env_mode_flag=!1;this._texture_env_mode=0;this._position_buffer=null;this._normal_buffer=null;this._color_buffer=null;this._texture_coord_buffer=null;this._strip_buffer=null}function o(n){this._data=n;this._cur=0}function yt(n,t,i,u,f){var h,st,ht,ct,l,p,ft,w,a,nt;h=n instanceof o?n:new o(n);for(var et=new v(i,u,f),e,ot,tt,it,rt,ut,y=h.get(),vt=new Array(y),b=new Array(y*4),k=new Array(y*4),d=new Array(y*4),g=new Array(y*4),yt=new Array(y),s=0;s<y;s++)vt[s]=h.get(),b[s*4]=h.get(),b[s*4+1]=b[s*4],b[s*4+2]=b[s*4],b[s*4+3]=1,k[s*4]=h.get(),k[s*4+1]=k[s*4],k[s*4+2]=k[s*4],k[s*4+3]=1,d[s*4]=h.get(),d[s*4+1]=d[s*4],d[s*4+2]=d[s*4],d[s*4+3]=1,g[s*4]=h.get(),g[s*4+1]=g[s*4],g[s*4+2]=g[s*4],g[s*4+3]=1,yt[s]=h.get()*128/100;et.setMaterial(y,vt,b,k,d,g,yt);var gt=h.get()*t,ni=h.get()*t,ti=h.get()*t,ii=h.get(),ri=h.get(),ui=h.get(),fi=h.get();if(r.setIdentity(),r.translate(gt,ni,ti),r.rotate(ri,ui,fi,ii),l=h.get(),tt=null,p=null,l>0)for(tt=new Array(l),p=new Array(l),e=0;e<l;e++)if(tt[e]=h.get(),tt[e]<=0)p[e]=null;else for(p[e]=new Array(tt[e]*3),s=0;s<tt[e];s++)st=h.get()*t,ht=h.get()*t,ct=h.get()*t,r.transVector(st,ht,ct),p[e][s*3]=r.transX(),p[e][s*3+1]=r.transY(),p[e][s*3+2]=r.transZ();if(ft=h.get(),it=null,w=null,ft>0)for(it=new Array(l),w=new Array(l),e=0;e<l;e++)if(it[e]=h.get(),it[e]<=0)w[e]=null;else for(w[e]=new Array(it[e]*3),s=0;s<it[e];s++)st=h.get(),ht=h.get(),ct=h.get(),r.transVector(st,ht,ct),w[e][s*3]=r.transX(),w[e][s*3+1]=r.transY(),w[e][s*3+2]=r.transZ();if(ft=h.get(),rt=null,a=null,ft>0)for(rt=new Array(l),a=new Array(l),e=0;e<l;e++)if(rt[e]=h.get(),rt[e]<=0)a[e]=null;else for(a[e]=new Array(rt[e]*4),s=0;s<rt[e];s++)a[e][s*4]=h.get(),a[e][s*4+1]=h.get(),a[e][s*4+2]=h.get(),a[e][s*4+3]=1;if(ft=h.get(),ut=null,nt=null,ft>0)for(ut=new Array(l),nt=new Array(l),e=0;e<l;e++)if(ut[e]=h.get(),ut[e]<=0)nt[e]=null;else for(nt[e]=new Array(ut[e]*2),s=0;s<ut[e];s++)nt[e][s*2]=h.get(),nt[e][s*2+1]=h.get();et.setObject(l,p,w,a,nt);var c=h.get(),ei=new Array(c),oi=new Array(c),si=new Array(c),hi=new Array(c),ci=new Array(c),li=new Array(c),ai=new Array(c),pt=new Array(c),wt=new Array(c),bt=new Array(c),kt=new Array(c),dt=new Array(c),lt=new Array(c),at=new Array(c);for(e=0;e<c;e++)for(ei[e]=h.get()*t,oi[e]=h.get()*t,si[e]=h.get()*t,hi[e]=h.get(),ci[e]=h.get(),li[e]=h.get(),ai[e]=h.get(),pt[e]=h.get(),wt[e]=h.get(),bt[e]=h.get(),kt[e]=h.get(),dt[e]=h.get(),lt[e]=h.get(),at[e]=new Array(lt[e]),ot=0;ot<lt[e];ot++)at[e][ot]=h.get();return et.setStrip(c,pt,wt,bt,kt,dt,lt,at),et}function s(){this._type=0;this._depth=!1;this._trans=1}function g(n,t){this._program=d(n,t)}function nt(n){this._glp=new s;this._glp.setType(1);this._glp.setDepth(n);this._coord=new Array(12);this._map=new Array(8);this._uv=new Array(8);this._uv_f=!0;this._coord_buffer=i.createBuffer();this._uv_buffer=i.createBuffer();this._coord[0]=-1;this._coord[1]=-1;this._coord[2]=0;this._coord[3]=1;this._coord[4]=-1;this._coord[5]=0;this._coord[6]=-1;this._coord[7]=1;this._coord[8]=0;this._coord[9]=1;this._coord[10]=1;this._coord[11]=0;this._uv[0]=0;this._uv[1]=1;this._uv[2]=1;this._uv[3]=1;this._uv[4]=0;this._uv[5]=0;this._uv[6]=1;this._uv[7]=0}function tt(n,t){var i;for(this._img_array=n,this._num=n.length,this._gen_num=t,this._id=new Array(this._gen_num),r.genTextures(this._gen_num,this._id),this._gen=!0,this._use_id=new Array(this._gen_num),i=0;i<this._gen_num;i++)this._use_id[i]=!1;for(this._index2id=new Array(this._num),this._width=new Array(this._num),this._height=new Array(this._num),this._image_data=new Array(this._num),this._t_rgba=new Array(this._num),this._t_a=new Array(this._num),this._t_trans=new Array(this._num),this._t_alpha=new Array(this._num),this._tx=new Array(this._num),this._ty=new Array(this._num),this._apply_tx=new Array(this._num),this._apply_ty=new Array(this._num),i=0;i<this._num;i++)this._index2id[i]=-1,this._image_data[i]=null,this._t_rgba[i]=null,this._t_a[i]=null,this._tx[i]=0,this._ty[i]=0,this._apply_tx[i]=0,this._apply_ty[i]=0}function it(n,t){var i,u;for(this._num=0,r.beginGetTriangle();r.getTriangle(n,t,!1);)this._num++;if(this._coord_x=null,this._coord_y=null,this._coord_z=null,this._normal_x=null,this._normal_y=null,this._normal_z=null,this._center_x=null,this._center_y=null,this._center_z=null,this._num>0){for(this._coord_x=new Array(this._num),this._coord_y=new Array(this._num),this._coord_z=new Array(this._num),i=0;i<this._num;i++)this._coord_x[i]=new Array(3),this._coord_y[i]=new Array(3),this._coord_z[i]=new Array(3);for(this._normal_x=new Array(this._num),this._normal_y=new Array(this._num),this._normal_z=new Array(this._num),this._center_x=new Array(this._num),this._center_y=new Array(this._num),this._center_z=new Array(this._num),u=0,r.beginGetTriangle();r.getTriangle(n,t,!1);){for(i=0;i<3;i++)this._coord_x[u][i]=r.coordX(i),this._coord_y[u][i]=r.coordY(i),this._coord_z[u][i]=r.coordZ(i);r.getTriangleNormal(n,t,!1);this._normal_x[u]=r.normalX();this._normal_y[u]=r.normalY();this._normal_z[u]=r.normalZ();this._center_x[u]=r.centerX();this._center_y[u]=r.centerY();this._center_z[u]=r.centerZ();u++}}}function y(){this.util_mat=new Array(16);this.tmp_mat=new Array(16);this.save_mat=new Array(16);this._rotate=new Array(16);this._rotate[3]=0;this._rotate[7]=0;this._rotate[11]=0;this._rotate[12]=0;this._rotate[13]=0;this._rotate[14]=0;this._rotate[15]=1;this._scale=new Array(16);this._scale[0]=1;this._scale[1]=0;this._scale[2]=0;this._scale[3]=0;this._scale[4]=0;this._scale[5]=1;this._scale[6]=0;this._scale[7]=0;this._scale[8]=0;this._scale[9]=0;this._scale[10]=1;this._scale[11]=0;this._scale[12]=0;this._scale[13]=0;this._scale[14]=0;this._scale[15]=1;this._translate=new Array(16);this._translate[0]=1;this._translate[1]=0;this._translate[2]=0;this._translate[3]=0;this._translate[4]=0;this._translate[5]=1;this._translate[6]=0;this._translate[7]=0;this._translate[8]=0;this._translate[9]=0;this._translate[10]=1;this._translate[11]=0;this._translate[12]=0;this._translate[13]=0;this._translate[14]=0;this._translate[15]=1;this.trans_x=0;this.trans_y=0;this.trans_z=0;this.cross_x=0;this.cross_y=0;this.cross_z=0;this.normalize_x=0;this.normalize_y=0;this.normalize_z=0;this.reflect_x=0;this.reflect_y=0;this.reflect_z=0;this.seek_len=0;this.seek_vertex=new Array(3);this.coord_x=new Array(3);this.coord_y=new Array(3);this.coord_z=new Array(3);this.normal_x=0;this.normal_y=0;this.normal_z=0;this.center_x=0;this.center_y=0;this.center_z=0;this.hit_x=0;this.hit_y=0;this.hit_z=0;this.position_x=0;this.position_y=0;this.position_z=0;this.look_side=new Array(3);this.look_mat=new Array(16);this.model_mat=new Array(16);this.proj_mat=new Array(16);this.view_mat=new Array(4);this.project_in=new Array(4);this.project_out=new Array(4);this.project_x=0;this.project_y=0;this.project_z=0}var f=n.document,h="canvas",c="webgl",l="2d",rt="left",ut="bottom",ft="string",et=",",p=".",ot="0",st="-",ht="-0",i,r,u,b;e.prototype={draw:function(n,t){switch(this._p.type()){case 0:this._p.setTransparency(this._trans);this._p.draw(n,this._index,this._tex_index,t);break;case 1:this._p.setTransparency(this._trans);this._p.draw(n,this._tex_index,t)}}};w.prototype={clear:function(){this._draw=[]},add:function(n,t,i,r,u){if(n.type()==0&&t<0)for(var f=n.stripNum()-1;f>=0;f--)this._draw[this._draw.length]=new e(n,f,i,r,u,!1);else this._draw[this._draw.length]=new e(n,t,i,r,u,!1)},addSprite:function(n,t,i,u,f,o){var s=this._draw.length;return this._draw[s]=new e(n,-1,t,r.spriteMatrix(i,u,f),o,!0,i,u,f),this._draw[s]._distance},draw:function(n){for(var f,s,r,u=this._draw.length,e=[],o=0,t=0;t<u;t++)this._draw[t]._distance==0&&(this._draw[t]._distance=-1,e[o++]=this._draw[t]);for(;o<u;o++){for(s=0,f=0,t=0;t<u;t++)this._draw[t]._distance>=s&&(s=this._draw[t]._distance,f=t);this._draw[f]._distance=-1;e[o]=this._draw[f]}for(t=0;t<u;t++)r=e[t],glDrawUseProgram(i,r._p,r._index),glDrawSetProjectionMatrix(i,this._proj_mat,r._p,r._index),glDrawSetModelViewMatrix(i,r._mat,r._p,r._index),r.draw(n,!1);for(t=0;t<u;t++)r=e[t],glDrawUseProgram(i,r._p,r._index),glDrawSetProjectionMatrix(i,this._proj_mat,r._p,r._index),glDrawSetModelViewMatrix(i,r._mat,r._p,r._index),r.draw(n,!0)}};u=null;b=function(){u!=null&&(getCurrentContext().clearRect(0,0,getWidth(),getHeight()),getCurrentContext().save(),clear2D(getGraphics()));paint3D(i,r);u!=null&&(paint2D(getGraphics()),getCurrentContext().restore())};v.prototype={type:function(){return this._glp.type()},depth:function(){return this._glp.depth()},setTransparency:function(n){this._glp.setTransparency(n)},transparency:function(){return this._glp.transparency()},setMaterial:function(n,t,i,r,u,f,e){this._material_num=n;this._material_texture=t;this._material_diffuse=i;this._material_ambient=r;this._material_emission=u;this._material_specular=f;this._material_shininess=e},setObject:function(n,t,i,r,u){this._object_num=n;this._coord=t;this._normal=i;this._color=r;this._map=u},setStrip:function(n,t,i,r,u,f,e,o){this._strip_num=n;this._strip_material=t;this._strip_coord=i;this._strip_normal=r;this._strip_color=u;this._strip_map=f;this._strip_len=e;this._strip=o},setStripTranslate:function(n,t,i){this._strip_tx=n;this._strip_ty=t;this._strip_tz=i},setStripRotate:function(n,t,i,r){this._strip_or=n;this._strip_ox=t;this._strip_oy=i;this._strip_oz=r},setTextureEnvMode:function(n){this._texture_env_mode_flag=!0;this._texture_env_mode=n},stripNum:function(){return this._strip_num},textureIndex:function(n){return this._strip_material[n]<0?-1:this._material_texture[this._strip_material[n]]},textureAlpha:function(n,t,i){var u=!1,r=this.depth();return i<0&&(i=this.textureIndex(t)),i>=0&&(n.use(i),n.setTransparency(i,this.transparency()),u=n.alpha(i),r&&(r=n.depth(i))),u&&!r},draw:function(n,t,r,u){var a=this.textureAlpha(n,t,r),e,v,o,f,p;if(this.transparency()!=1&&(a=!0),a==u){if(this._strip_coord[t]>=0&&(this._position_buffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,this._position_buffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(this._coord[this._strip_coord[t]]),i.STATIC_DRAW),glModelBindPositionBuffer(i,this._id,this._lighting),i.bindBuffer(i.ARRAY_BUFFER,null)),this._normal!=null&&this._strip_normal[t]>=0&&(this._normal_buffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,this._normal_buffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(this._normal[this._strip_normal[t]]),i.STATIC_DRAW),glModelBindNormalBuffer(i,this._id,this._lighting),i.bindBuffer(i.ARRAY_BUFFER,null)),this._color!=null&&this._strip_color[t]>=0){if(v=this.transparency(),v!=1)for(o=this._color[this._strip_color[t]],e=new Array(o.length),f=0;f<o.length;f+=4)e[f]=o[f],e[f+1]=o[f+1],e[f+2]=o[f+2],e[f+3]=o[f+3]*v;else e=this._color[this._strip_color[t]];this._color_buffer=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,this._color_buffer);i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.STATIC_DRAW);glModelBindColorBuffer(i,this._id,this._lighting);i.bindBuffer(i.ARRAY_BUFFER,null)}r<0&&(r=this.textureIndex(t));glModelSetTexture(i,n,t,r,this._id,this._lighting)||this._map!=null&&this._strip_map[t]>=0&&r>=0&&(i.activeTexture(glModelActiveTexture(i,this._id)),n.bindTexture(i.TEXTURE_2D,n.id(r)),this._texture_coord_buffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,this._texture_coord_buffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(this._map[this._strip_map[t]]),i.STATIC_DRAW),glModelBindTextureCoordBuffer(i,this._id,this._lighting),i.bindBuffer(i.ARRAY_BUFFER,null));var s=null,h=null,c=null,l=null,y=null;this._material_diffuse!=null&&this._strip_material[t]>=0&&(s=new Array(4),s[0]=this._material_diffuse[this._strip_material[t]*4],s[1]=this._material_diffuse[this._strip_material[t]*4+1],s[2]=this._material_diffuse[this._strip_material[t]*4+2],s[3]=this._material_diffuse[this._strip_material[t]*4+3]);this._material_ambient!=null&&this._strip_material[t]>=0&&(h=new Array(4),h[0]=this._material_ambient[this._strip_material[t]*4],h[1]=this._material_ambient[this._strip_material[t]*4+1],h[2]=this._material_ambient[this._strip_material[t]*4+2],h[3]=this._material_ambient[this._strip_material[t]*4+3]);this._material_emission!=null&&this._strip_material[t]>=0&&(c=new Array(4),c[0]=this._material_emission[this._strip_material[t]*4],c[1]=this._material_emission[this._strip_material[t]*4+1],c[2]=this._material_emission[this._strip_material[t]*4+2],c[3]=this._material_emission[this._strip_material[t]*4+3]);this._material_specular!=null&&this._strip_material[t]>=0&&(l=new Array(4),l[0]=this._material_specular[this._strip_material[t]*4],l[1]=this._material_specular[this._strip_material[t]*4+1],l[2]=this._material_specular[this._strip_material[t]*4+2],l[3]=this._material_specular[this._strip_material[t]*4+3]);this._material_shininess!=null&&this._strip_material[t]>=0&&(y=this._material_shininess[this._strip_material[t]]);a&&(i.enable(i.BLEND),i.depthMask(!1));glModelBeginDraw(i,n,t,r,this._id,this._lighting,s,h,c,l,y)&&(this._strip_buffer=i.createBuffer(),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._strip_buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(this._strip[t]),i.STATIC_DRAW),p=i.getBufferParameter(i.ELEMENT_ARRAY_BUFFER,i.BUFFER_SIZE)/2,i.drawElements(i.TRIANGLE_STRIP,p,i.UNSIGNED_SHORT,0),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),glModelEndDraw(i,n,t,r,this._id,this._lighting));a&&(i.disable(i.BLEND),i.depthMask(!0))}}};o.prototype={get:function(){if(typeof this._data==ft){for(var n="",t;(t=this._data.charAt(this._cur++))!=et;)if(n+=t,this._cur>=this._data.length)break;return n.length>0?n.charAt(0)==p?Number(ot+n):n.charAt(0)==st&&n.length>1&&n.charAt(1)==p?Number(ht+n.substring(1)):Number(n):0}return this._data[this._cur++]}};s.prototype={setType:function(n){this._type=n},setDepth:function(n){this._depth=n},setTransparency:function(n){this._trans=n},type:function(){return this._type},depth:function(){return this._depth},transparency:function(){return this._trans}};g.prototype={attrib:function(n){return i.getAttribLocation(this._program,n)},uniform:function(n){return i.getUniformLocation(this._program,n)},use:function(){i.useProgram(this._program)}};nt.prototype={type:function(){return this._glp.type()},depth:function(){return this._glp.depth()},setTransparency:function(n){this._glp.setTransparency(n)},transparency:function(){return this._glp.transparency()},setCoord:function(n){for(var t=0;t<12;t++)this._coord[t]=n[t]},setMap:function(n,i){var r;if(i==t&&(i=!1),this._uv_f=i,this._uv_f)for(r=0;r<8;r++)this._uv[r]=n[r];else for(r=0;r<8;r++)this._map[r]=n[r]},textureAlpha:function(n,t){return n.use(t),n.setTransparency(t,this.transparency()),n.alpha(t)&&!this.depth()},draw:function(n,t,r){var f=this.textureAlpha(n,t),e,o,u;if(this.transparency()!=1&&(f=!0),f==r){if(i.bindBuffer(i.ARRAY_BUFFER,this._coord_buffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(this._coord),i.STATIC_DRAW),glSpriteBindPositionBuffer(i),i.bindBuffer(i.ARRAY_BUFFER,null),!this._uv_f)for(e=n.width(t),o=n.height(t),u=0;u<4;u++)this._uv[u*2]=this._map[u*2]/e,this._uv[u*2+1]=this._map[u*2+1]/o;i.bindBuffer(i.ARRAY_BUFFER,this._uv_buffer);i.bufferData(i.ARRAY_BUFFER,new Float32Array(this._uv),i.STATIC_DRAW);glSpriteBindTextureCoordBuffer(i);i.bindBuffer(i.ARRAY_BUFFER,null);i.activeTexture(i.TEXTURE0);n.bindTexture(i.TEXTURE_2D,n.id(t));f&&(i.enable(i.BLEND),i.depthMask(!1));i.drawArrays(i.TRIANGLE_STRIP,0,4);f&&(i.disable(i.BLEND),i.depthMask(!0))}}};tt.prototype={_SHIFTL:function(n){return n*16777216},_SHIFTR:function(n){return _DIV(n,16777216)},bindTexture:function(n,t){r.bindTexture(n,t)},dispose:function(){for(var n=0;n<this._num;n++)this.unuse(n);this._gen&&(r.deleteTextures(this._gen_num,this._id),this._gen=!1)},imageDataFromImage:function(n){var t=f.createElement(h),i=t.getContext(l);return t.width=n.width,t.height=n.height,i.drawImage(n,0,0),i.getImageData(0,0,t.width,t.height)},imageDataFromPixels:function(n,t,i){var r=f.createElement(h),p=r.getContext(l),v,u,e,a,y,o,s,c;for(r.width=t,r.height=i,v=p.getImageData(0,0,r.width,r.height),u=v.data,a=0;a<i;a++)for(y=a*t,s=y*4,e=0;e<t;e++)o=e*4,c=n[y+e],u[s+o]=this._SHIFTR(c)&255,u[s+o+1]=c>>16&255,u[s+o+2]=c>>8&255,u[s+o+3]=c&255;return v},getTextureSize:function(n){for(var t=1;;){if(t>=n)break;t*=2}return t},use:function(n,u){var f,o,e;if(!(this._index2id[n]>=0)){for(u==t&&(u=!1),this._index2id[n]=0,f=0;f<this._gen_num;f++)if(!this._use_id[f]){this._use_id[f]=!0;this._index2id[n]=f;break}if(this._image_data[n]=this.imageDataFromImage(this._img_array[n]),this._width[n]=this._image_data[n].width,this._height[n]=this._image_data[n].height,u)for(o=this._width[n]*this._height[n],this._t_rgba[n]=new Array(o),this._t_a[n]=new Array(o),e=this._image_data[n].data,f=0;f<o;f++)this._t_rgba[n][f]=this._SHIFTL(e[f*4])+(e[f*4+1]<<16)+(e[f*4+2]<<8)+e[f*4+3],this._t_a[n][f]=e[f*4+3];this._t_trans[n]=1;this._t_alpha[n]=glTextureAlphaFlag(n);r.bindTexture(this._id[this._index2id[n]]);i.pixelStorei(i.UNPACK_ALIGNMENT,1);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,glTextureFlipY(n));r.texImage2D(this._image_data[n]);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,glTextureFilter(i,n));i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,glTextureFilter(i,n));i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,glTextureWrap(i,n));i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,glTextureWrap(i,n))}},unuse:function(n){this._index2id[n]>=0&&(this._use_id[this._index2id[n]]=!1,this._image_data[n]=null,this._t_rgba[n]=null,this._t_a[n]=null,this._index2id[n]=-1)},unuseAll:function(){for(var n=0;n<this._num;n++)this.unuse(n);r.deleteTextures(this._gen_num,this._id);r.genTextures(this._gen_num,this._id)},update:function(n,t,u){var e,f;if(this._index2id[n]>=0&&(e=this._width[n]*this._height[n],u==e)){if(this._image_data[n]=this.imageDataFromPixels(t,this._width[n],this._height[n]),this._t_rgba[n]!=null&&this._t_a[n]!=null)for(_System.arraycopy(t,0,this._t_rgba[n],0,e),f=0;f<e;f++)this._t_a[n][f]=this._t_rgba[n][f]&255;this._t_trans[n]=1;this._t_alpha[n]=glTextureAlphaFlag(n);i.pixelStorei(i.UNPACK_ALIGNMENT,1);r.bindTexture(this._id[this._index2id[n]]);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,glTextureFlipY(n));r.texImage2D(this._image_data[n])}},setTransparency:function(n,t){var f,e,o,s,h,u;if(this._t_rgba[n]!=null&&this._t_a[n]!=null&&(this.use(n),t!=this._t_trans[n])){for(this._t_trans[n]=t,f=this._width[n]*this._height[n],u=0;u<f;u++)e=this._SHIFTR(this._t_rgba[n][u])&255,o=this._t_rgba[n][u]>>16&255,s=this._t_rgba[n][u]>>8&255,h=_INT(this._t_a[n][u]*this._t_trans[n]),this._t_rgba[n][u]=this._SHIFTL(e)+(o<<16)+(s<<8)+h;this._image_data[n]=this.imageDataFromPixels(this._t_rgba[n],this._width[n],this._height[n]);this._t_alpha[n]=this._t_trans[n]==1?glTextureAlphaFlag(n):!0;i.pixelStorei(i.UNPACK_ALIGNMENT,1);r.bindTexture(this._id[this._index2id[n]]);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,glTextureFlipY(n));r.texImage2D(this._image_data[n])}},translate:function(n,t,u){var o,l,a,e,c;this.use(n);o=this._width[n];l=this._height[n];this._tx[n]=t*o;this._ty[n]=u*l;var v=this._apply_tx[n]-_INT(this._tx[n]),y=this._apply_ty[n]-_INT(this._ty[n]),p=glTextureWrap(i,n)==i.REPEAT,f,h,s;if(v!=0)if(this._apply_tx[n]=_INT(this._tx[n]),this._t_rgba[n]!=null&&this._t_a[n]!=null)for(e=new Array(2),e[0]=new Array(o),e[1]=new Array(o),c=new Array(2),c[0]=this._t_rgba[n],c[1]=this._t_a[n],f=0;f<l;f++){for(a=f*o,h=0;h<o;h++)if(s=h-v,p){while(s<0)s+=o;while(s>=o)s-=o;e[0][h]=c[0][a+s];e[1][h]=c[1][a+s]}else s<0||s>=o?(e[0][h]=0,e[1][h]=0):(e[0][h]=c[0][a+s],e[1][h]=c[1][a+s]);_System.arraycopy(e[0],0,c[0],a,o);_System.arraycopy(e[1],0,c[1],a,o)}else for(e=new Array(o*4),c=this._image_data[n].data,f=0;f<l;f++){for(a=f*o,h=0;h<o;h++)if(s=h-v,p){while(s<0)s+=o;while(s>=o)s-=o;e[h*4]=c[(a+s)*4];e[h*4+1]=c[(a+s)*4+1];e[h*4+2]=c[(a+s)*4+2];e[h*4+3]=c[(a+s)*4+3]}else s<0||s>=o?(e[h*4]=0,e[h*4+1]=0,e[h*4+2]=0,e[h*4+3]=0):(e[h*4]=c[(a+s)*4],e[h*4+1]=c[(a+s)*4+1],e[h*4+2]=c[(a+s)*4+2],e[h*4+3]=c[(a+s)*4+3]);_System.arraycopy(e,0,c,a*4,o*4)}if(y!=0)if(this._apply_ty[n]=_INT(this._ty[n]),this._t_rgba[n]!=null&&this._t_a[n]!=null){for(e=new Array(2),e[0]=new Array(l),e[1]=new Array(l),f=0;f<l;f++)e[0][f]=new Array(o),e[1][f]=new Array(o);for(c=new Array(2),c[0]=this._t_rgba[n],c[1]=this._t_a[n],f=0;f<l;f++)if(s=f-y,p){while(s<0)s+=l;while(s>=l)s-=l;_System.arraycopy(c[0],s*o,e[0][f],0,o);_System.arraycopy(c[1],s*o,e[1][f],0,o)}else if(s<0||s>=o)for(h=0;h<o;h++)e[0][f][h]=0,e[1][f][h]=0;else _System.arraycopy(c[0],s*o,e[0][f],0,o),_System.arraycopy(c[1],s*o,e[1][f],0,o);for(f=0;f<l;f++)_System.arraycopy(e[0][f],0,c[0],f*o,o),_System.arraycopy(e[1][f],0,c[1],f*o,o)}else{for(e=new Array(l),f=0;f<l;f++)e[f]=new Array(o*4);for(c=this._image_data[n].data,f=0;f<l;f++)if(s=f-y,p){while(s<0)s+=l;while(s>=l)s-=l;_System.arraycopy(c,s*o*4,e[f],0,o*4)}else if(s<0||s>=o)for(h=0;h<o;h++)e[f][h*4]=0,e[f][h*4+1]=0,e[f][h*4+2]=0,e[f][h*4+3]=0;else _System.arraycopy(c,s*o*4,e[f],0,o*4);for(f=0;f<l;f++)_System.arraycopy(e[f],0,c,f*o*4,o*4)}(v!=0||y!=0)&&(this._t_rgba[n]!=null&&(this._image_data[n]=this.imageDataFromPixels(this._t_rgba[n],o,l)),i.pixelStorei(i.UNPACK_ALIGNMENT,1),r.bindTexture(this._id[this._index2id[n]]),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,glTextureFlipY(n)),r.texImage2D(this._image_data[n]))},id:function(n){return this._id[this._index2id[n]]},width:function(n){return this._width[n]},height:function(n){return this._height[n]},alpha:function(n){return this._t_alpha[n]},depth:function(n){return glTextureDepthFlag(n)}};it.prototype={num:function(){return this._num},coord_x:function(n){return this._coord_x[n]},coord_y:function(n){return this._coord_y[n]},coord_z:function(n){return this._coord_z[n]},normal_x:function(n){return this._normal_x[n]},normal_y:function(n){return this._normal_y[n]},normal_z:function(n){return this._normal_z[n]},center_x:function(n){return this._center_x[n]},center_y:function(n){return this._center_y[n]},center_z:function(n){return this._center_z[n]},check:function(n,t,i,r,u,f,e){return this._center_x[n]>=t&&this._center_x[n]<=i&&this._center_y[n]>=r&&this._center_y[n]<=u&&this._center_z[n]>=f&&this._center_z[n]<=e?!0:!1},hitCheck:function(n,t,i,u,f,e,o){for(var s=0;s<this._num;s++)if(this._center_x[s]>=n-o&&this._center_x[s]<=n+o&&this._center_y[s]>=t-o&&this._center_y[s]<=t+o&&this._center_z[s]>=i-o&&this._center_z[s]<=i+o&&r.hitCheck(n,t,i,u,f,e,this._coord_x[s],this._coord_y[s],this._coord_z[s]))return s;return-1}};y.prototype={genTextures:function(n,t){for(var r=0;r<n;r++)t[r]=i.createTexture()},deleteTextures:function(n,t){for(var r=0;r<n;r++)i.deleteTexture(t[r])},bindTexture:function(n,r){r==t&&(r=n,n=i.TEXTURE_2D);i.bindTexture(n,r)},texImage2D:function(n,r){r==t&&(r=n,n=i.TEXTURE_2D);var u=i.RGBA,f=i.RGBA,e=i.UNSIGNED_BYTE;i.texImage2D(n,0,u,f,e,r)},deg2rad:function(n){return n*3.1415926535897931/180},rad2deg:function(n){return n*180/3.1415926535897931},glMatrix:function(){for(var i=new Float32Array(16),n,r,t=0;t<4;t++)for(r=t*4,n=0;n<4;n++)i[r+n]=this.util_mat[n*4+t];return i},utMatrix:function(n){for(var r=new Array(16),t,u,i=0;i<4;i++)for(u=i*4,t=0;t<4;t++)r[u+t]=n[t*4+i];return r},push:function(){for(var n=0;n<16;n++)this.save_mat[n]=this.util_mat[n]},pop:function(){for(var n=0;n<16;n++)this.util_mat[n]=this.save_mat[n]},invert:function(){var n,t;if(this.tmp_mat[0]=this.util_mat[5]*this.util_mat[10]*this.util_mat[15]-this.util_mat[5]*this.util_mat[11]*this.util_mat[14]-this.util_mat[9]*this.util_mat[6]*this.util_mat[15]+this.util_mat[9]*this.util_mat[7]*this.util_mat[14]+this.util_mat[13]*this.util_mat[6]*this.util_mat[11]-this.util_mat[13]*this.util_mat[7]*this.util_mat[10],this.tmp_mat[4]=-this.util_mat[4]*this.util_mat[10]*this.util_mat[15]+this.util_mat[4]*this.util_mat[11]*this.util_mat[14]+this.util_mat[8]*this.util_mat[6]*this.util_mat[15]-this.util_mat[8]*this.util_mat[7]*this.util_mat[14]-this.util_mat[12]*this.util_mat[6]*this.util_mat[11]+this.util_mat[12]*this.util_mat[7]*this.util_mat[10],this.tmp_mat[8]=this.util_mat[4]*this.util_mat[9]*this.util_mat[15]-this.util_mat[4]*this.util_mat[11]*this.util_mat[13]-this.util_mat[8]*this.util_mat[5]*this.util_mat[15]+this.util_mat[8]*this.util_mat[7]*this.util_mat[13]+this.util_mat[12]*this.util_mat[5]*this.util_mat[11]-this.util_mat[12]*this.util_mat[7]*this.util_mat[9],this.tmp_mat[12]=-this.util_mat[4]*this.util_mat[9]*this.util_mat[14]+this.util_mat[4]*this.util_mat[10]*this.util_mat[13]+this.util_mat[8]*this.util_mat[5]*this.util_mat[14]-this.util_mat[8]*this.util_mat[6]*this.util_mat[13]-this.util_mat[12]*this.util_mat[5]*this.util_mat[10]+this.util_mat[12]*this.util_mat[6]*this.util_mat[9],this.tmp_mat[1]=-this.util_mat[1]*this.util_mat[10]*this.util_mat[15]+this.util_mat[1]*this.util_mat[11]*this.util_mat[14]+this.util_mat[9]*this.util_mat[2]*this.util_mat[15]-this.util_mat[9]*this.util_mat[3]*this.util_mat[14]-this.util_mat[13]*this.util_mat[2]*this.util_mat[11]+this.util_mat[13]*this.util_mat[3]*this.util_mat[10],this.tmp_mat[5]=this.util_mat[0]*this.util_mat[10]*this.util_mat[15]-this.util_mat[0]*this.util_mat[11]*this.util_mat[14]-this.util_mat[8]*this.util_mat[2]*this.util_mat[15]+this.util_mat[8]*this.util_mat[3]*this.util_mat[14]+this.util_mat[12]*this.util_mat[2]*this.util_mat[11]-this.util_mat[12]*this.util_mat[3]*this.util_mat[10],this.tmp_mat[9]=-this.util_mat[0]*this.util_mat[9]*this.util_mat[15]+this.util_mat[0]*this.util_mat[11]*this.util_mat[13]+this.util_mat[8]*this.util_mat[1]*this.util_mat[15]-this.util_mat[8]*this.util_mat[3]*this.util_mat[13]-this.util_mat[12]*this.util_mat[1]*this.util_mat[11]+this.util_mat[12]*this.util_mat[3]*this.util_mat[9],this.tmp_mat[13]=this.util_mat[0]*this.util_mat[9]*this.util_mat[14]-this.util_mat[0]*this.util_mat[10]*this.util_mat[13]-this.util_mat[8]*this.util_mat[1]*this.util_mat[14]+this.util_mat[8]*this.util_mat[2]*this.util_mat[13]+this.util_mat[12]*this.util_mat[1]*this.util_mat[10]-this.util_mat[12]*this.util_mat[2]*this.util_mat[9],this.tmp_mat[2]=this.util_mat[1]*this.util_mat[6]*this.util_mat[15]-this.util_mat[1]*this.util_mat[7]*this.util_mat[14]-this.util_mat[5]*this.util_mat[2]*this.util_mat[15]+this.util_mat[5]*this.util_mat[3]*this.util_mat[14]+this.util_mat[13]*this.util_mat[2]*this.util_mat[7]-this.util_mat[13]*this.util_mat[3]*this.util_mat[6],this.tmp_mat[6]=-this.util_mat[0]*this.util_mat[6]*this.util_mat[15]+this.util_mat[0]*this.util_mat[7]*this.util_mat[14]+this.util_mat[4]*this.util_mat[2]*this.util_mat[15]-this.util_mat[4]*this.util_mat[3]*this.util_mat[14]-this.util_mat[12]*this.util_mat[2]*this.util_mat[7]+this.util_mat[12]*this.util_mat[3]*this.util_mat[6],this.tmp_mat[10]=this.util_mat[0]*this.util_mat[5]*this.util_mat[15]-this.util_mat[0]*this.util_mat[7]*this.util_mat[13]-this.util_mat[4]*this.util_mat[1]*this.util_mat[15]+this.util_mat[4]*this.util_mat[3]*this.util_mat[13]+this.util_mat[12]*this.util_mat[1]*this.util_mat[7]-this.util_mat[12]*this.util_mat[3]*this.util_mat[5],this.tmp_mat[14]=-this.util_mat[0]*this.util_mat[5]*this.util_mat[14]+this.util_mat[0]*this.util_mat[6]*this.util_mat[13]+this.util_mat[4]*this.util_mat[1]*this.util_mat[14]-this.util_mat[4]*this.util_mat[2]*this.util_mat[13]-this.util_mat[12]*this.util_mat[1]*this.util_mat[6]+this.util_mat[12]*this.util_mat[2]*this.util_mat[5],this.tmp_mat[3]=-this.util_mat[1]*this.util_mat[6]*this.util_mat[11]+this.util_mat[1]*this.util_mat[7]*this.util_mat[10]+this.util_mat[5]*this.util_mat[2]*this.util_mat[11]-this.util_mat[5]*this.util_mat[3]*this.util_mat[10]-this.util_mat[9]*this.util_mat[2]*this.util_mat[7]+this.util_mat[9]*this.util_mat[3]*this.util_mat[6],this.tmp_mat[7]=this.util_mat[0]*this.util_mat[6]*this.util_mat[11]-this.util_mat[0]*this.util_mat[7]*this.util_mat[10]-this.util_mat[4]*this.util_mat[2]*this.util_mat[11]+this.util_mat[4]*this.util_mat[3]*this.util_mat[10]+this.util_mat[8]*this.util_mat[2]*this.util_mat[7]-this.util_mat[8]*this.util_mat[3]*this.util_mat[6],this.tmp_mat[11]=-this.util_mat[0]*this.util_mat[5]*this.util_mat[11]+this.util_mat[0]*this.util_mat[7]*this.util_mat[9]+this.util_mat[4]*this.util_mat[1]*this.util_mat[11]-this.util_mat[4]*this.util_mat[3]*this.util_mat[9]-this.util_mat[8]*this.util_mat[1]*this.util_mat[7]+this.util_mat[8]*this.util_mat[3]*this.util_mat[5],this.tmp_mat[15]=this.util_mat[0]*this.util_mat[5]*this.util_mat[10]-this.util_mat[0]*this.util_mat[6]*this.util_mat[9]-this.util_mat[4]*this.util_mat[1]*this.util_mat[10]+this.util_mat[4]*this.util_mat[2]*this.util_mat[9]+this.util_mat[8]*this.util_mat[1]*this.util_mat[6]-this.util_mat[8]*this.util_mat[2]*this.util_mat[5],n=this.util_mat[0]*this.tmp_mat[0]+this.util_mat[1]*this.tmp_mat[4]+this.util_mat[2]*this.tmp_mat[8]+this.util_mat[3]*this.tmp_mat[12],n==0)return!1;for(n=1/n,t=0;t<16;t++)this.util_mat[t]=this.tmp_mat[t]*n;return!0},multiply:function(n){for(var t,i,r=0;r<4;r++)for(i=r*4,t=0;t<4;t++)this.tmp_mat[i+t]=this.util_mat[i]*n[t]+this.util_mat[i+1]*n[4+t]+this.util_mat[i+2]*n[8+t]+this.util_mat[i+3]*n[12+t];this.set(this.tmp_mat)},rotate:function(n,t,i,r){var e=Math.sqrt(t*t+i*i+r*r);e!=0&&(t/=e,i/=e,r/=e);var s=this.deg2rad(n),o=Math.cos(s),f=Math.sin(s),u=1-o;this._rotate[0]=t*t*u+o;this._rotate[1]=t*i*u-r*f;this._rotate[2]=t*r*u+i*f;this._rotate[4]=i*t*u+r*f;this._rotate[5]=i*i*u+o;this._rotate[6]=i*r*u-t*f;this._rotate[8]=t*r*u-i*f;this._rotate[9]=i*r*u+t*f;this._rotate[10]=r*r*u+o;this.multiply(this._rotate)},scale:function(n,t,i){this._scale[0]=n;this._scale[5]=t;this._scale[10]=i;this.multiply(this._scale)},get:function(){for(var t=new Array(16),n=0;n<16;n++)t[n]=this.util_mat[n];return t},set:function(n){for(var t=0;t<16;t++)this.util_mat[t]=n[t]},setVal:function(n,t){this.util_mat[n]=t},setIdentity:function(){this.util_mat[0]=1;this.util_mat[1]=0;this.util_mat[2]=0;this.util_mat[3]=0;this.util_mat[4]=0;this.util_mat[5]=1;this.util_mat[6]=0;this.util_mat[7]=0;this.util_mat[8]=0;this.util_mat[9]=0;this.util_mat[10]=1;this.util_mat[11]=0;this.util_mat[12]=0;this.util_mat[13]=0;this.util_mat[14]=0;this.util_mat[15]=1},translate:function(n,t,i){this._translate[3]=n;this._translate[7]=t;this._translate[11]=i;this.multiply(this._translate)},transpose:function(){for(var n,i,t=0;t<4;t++)for(i=t*4,n=0;n<4;n++)this.tmp_mat[i+n]=this.util_mat[n*4+t];this.set(this.tmp_mat)},transVector:function(n,t,i){this.trans_x=this.util_mat[0]*n+this.util_mat[1]*t+this.util_mat[2]*i+this.util_mat[3]*1;this.trans_y=this.util_mat[4]*n+this.util_mat[5]*t+this.util_mat[6]*i+this.util_mat[7]*1;this.trans_z=this.util_mat[8]*n+this.util_mat[9]*t+this.util_mat[10]*i+this.util_mat[11]*1},cross:function(n,t,i,r,u,f){this.cross_x=t*f-i*u;this.cross_y=i*r-n*f;this.cross_z=n*u-t*r},dot:function(n,t,i,r,u,f){return n*r+t*u+i*f},distance:function(n,t,i){return Math.sqrt(n*n+t*t+i*i)},normalize:function(n,t,i){var r=Math.sqrt(n*n+t*t+i*i);r!=0?(this.normalize_x=n/r,this.normalize_y=t/r,this.normalize_z=i/r):(this.normalize_x=0,this.normalize_y=0,this.normalize_z=0)},reflect:function(n,t,i,r,u,f){var e=this.dot(-n,-t,-i,r,u,f),o=r*e,s=u*e,h=f*e;this.reflect_x=n+o+o;this.reflect_y=t+s+s;this.reflect_z=i+h+h},beginGetTriangle:function(){this.seek_len=2},getTriangle:function(n,t,i){for(var u=!1,r;this.seek_len<n._strip_len[t];){for(r=0;r<3;r++)this.seek_vertex[r]=n._strip[t][this.seek_len-r];if(this.seek_len++,this.seek_vertex[0]!=this.seek_vertex[1]&&this.seek_vertex[0]!=this.seek_vertex[2]&&this.seek_vertex[1]!=this.seek_vertex[2]){u=!0;break}}return u&&(this.getTriangleCoord(n,t,i),this.center_x=(this.coord_x[0]+this.coord_x[1]+this.coord_x[2])/3,this.center_y=(this.coord_y[0]+this.coord_y[1]+this.coord_y[2])/3,this.center_z=(this.coord_z[0]+this.coord_z[1]+this.coord_z[2])/3),u},getTriangleCoord:function(n,t,i){for(var r=0;r<3;r++)this.coord_x[r]=n._coord[n._strip_coord[t]][this.seek_vertex[r]*3],this.coord_y[r]=n._coord[n._strip_coord[t]][this.seek_vertex[r]*3+1],this.coord_z[r]=n._coord[n._strip_coord[t]][this.seek_vertex[r]*3+2];if(i)for(r=0;r<3;r++)this.transVector(this.coord_x[r],this.coord_y[r],this.coord_z[r]),this.coord_x[r]=this.trans_x,this.coord_y[r]=this.trans_y,this.coord_z[r]=this.trans_z},getTriangleNormal:function(n,t,i){var e;if(n._strip_normal[t]>=0){var r=0,u=0,f=0;for(e=0;e<3;e++)r+=n._normal[n._strip_normal[t]][this.seek_vertex[e]*3],u+=n._normal[n._strip_normal[t]][this.seek_vertex[e]*3+1],f+=n._normal[n._strip_normal[t]][this.seek_vertex[e]*3+2];i&&(this.transVector(r,u,f),r=this.trans_x,u=this.trans_y,f=this.trans_z);this.cross(this.coord_x[1]-this.coord_x[0],this.coord_y[1]-this.coord_y[0],this.coord_z[1]-this.coord_z[0],this.coord_x[2]-this.coord_x[0],this.coord_y[2]-this.coord_y[0],this.coord_z[2]-this.coord_z[0]);this.cross_x=Math.abs(this.cross_x);this.cross_y=Math.abs(this.cross_y);this.cross_z=Math.abs(this.cross_z);(this.cross_x<1||this.cross_y<1||this.cross_z<1)&&(r=r<0?-this.cross_x:this.cross_x,u=u<0?-this.cross_y:this.cross_y,f=f<0?-this.cross_z:this.cross_z);this.normalize(r,u,f);this.normal_x=this.normalize_x;this.normal_y=this.normalize_y;this.normal_z=this.normalize_z}},checkTriangle:function(n,t,i,r,u,f){return this.center_x>=n&&this.center_x<=t&&this.center_y>=i&&this.center_y<=r&&this.center_z>=u&&this.center_z<=f?!0:!1},hitCheck:function(n,t,i,r,u,f,e,o,s){var c,h;this.cross(e[1]-e[0],o[1]-o[0],s[1]-s[0],e[2]-e[0],o[2]-o[0],s[2]-s[0]);var l=this.cross_x,a=this.cross_y,v=this.cross_z,y=r-n,p=u-t,w=f-i,k=l*(e[0]-n)+a*(o[0]-t)+v*(s[0]-i),b=this.dot(l,a,v,y,p,w);if(b==0||(c=k/b,c<0||c>1))return!1;for(this.hit_x=n+c*y,this.hit_y=t+c*p,this.hit_z=i+c*w,h=0;h<3;h++)if(this.cross(e[h==2?0:h+1]-e[h],o[h==2?0:h+1]-o[h],s[h==2?0:h+1]-s[h],this.hit_x-e[h],this.hit_y-o[h],this.hit_z-s[h]),this.cross_x*l<-1||this.cross_y*a<-1||this.cross_z*v<-1)return!1;return!0},lookAt:function(n,t,i,r,u,f,e,o,s){var h,c,l,a;for(this.position_x=n,this.position_y=t,this.position_z=i,r-=this.position_x,u-=this.position_y,f-=this.position_z,h=Math.sqrt(r*r+u*u+f*f),h!=0&&(r/=h,u/=h,f/=h),this.look_side[0]=u*s-f*o,this.look_side[1]=f*e-r*s,this.look_side[2]=r*o-u*e,h=Math.sqrt(this.look_side[0]*this.look_side[0]+this.look_side[1]*this.look_side[1]+this.look_side[2]*this.look_side[2]),h!=0&&(this.look_side[0]/=h,this.look_side[1]/=h,this.look_side[2]/=h),e=this.look_side[1]*f-this.look_side[2]*u,o=this.look_side[2]*r-this.look_side[0]*f,s=this.look_side[0]*u-this.look_side[1]*r,this.look_mat[0]=this.look_side[0],this.look_mat[1]=e,this.look_mat[2]=-r,this.look_mat[3]=0,this.look_mat[4]=this.look_side[1],this.look_mat[5]=o,this.look_mat[6]=-u,this.look_mat[7]=0,this.look_mat[8]=this.look_side[2],this.look_mat[9]=s,this.look_mat[10]=-f,this.look_mat[11]=0,this.look_mat[12]=0,this.look_mat[13]=0,this.look_mat[14]=0,this.look_mat[15]=1,l=0;l<4;l++)for(a=l*4,c=0;c<4;c++)this.model_mat[a+c]=this.look_mat[c*4+l];for(this.set(this.model_mat),this.translate(-this.position_x,-this.position_y,-this.position_z),c=0;c<16;c++)this.model_mat[c]=this.util_mat[c]},setModelMatrix:function(n){for(var t=0;t<16;t++)this.model_mat[t]=n[t]},lookMatrix:function(){return this.look_mat},spriteMatrix:function(n,t,i){return this.set(this.model_mat),this.translate(n,t,i),this.multiply(this.look_mat),this.glMatrix()},frustum:function(n,t,i,r,u,f){this.proj_mat[0]=2*u/(t-n);this.proj_mat[1]=0;this.proj_mat[2]=(t+n)/(t-n);this.proj_mat[3]=0;this.proj_mat[4]=0;this.proj_mat[5]=2*u/(r-i);this.proj_mat[6]=(r+i)/(r-i);this.proj_mat[7]=0;this.proj_mat[8]=0;this.proj_mat[9]=0;this.proj_mat[10]=-(f+u)/(f-u);this.proj_mat[11]=-(2*f*u)/(f-u);this.proj_mat[12]=0;this.proj_mat[13]=0;this.proj_mat[14]=-1;this.proj_mat[15]=0;this.multiply(this.proj_mat);for(var e=0;e<16;e++)this.proj_mat[e]=this.util_mat[e]},ortho:function(n,t,i,r,u,f){this.proj_mat[0]=2/(t-n);this.proj_mat[1]=0;this.proj_mat[2]=0;this.proj_mat[3]=-(t+n)/(t-n);this.proj_mat[4]=0;this.proj_mat[5]=2/(r-i);this.proj_mat[6]=0;this.proj_mat[7]=-(r+i)/(r-i);this.proj_mat[8]=0;this.proj_mat[9]=0;this.proj_mat[10]=-2/(f-u);this.proj_mat[11]=-(f+u)/(f-u);this.proj_mat[12]=0;this.proj_mat[13]=0;this.proj_mat[14]=0;this.proj_mat[15]=1;this.multiply(this.proj_mat);for(var e=0;e<16;e++)this.proj_mat[e]=this.util_mat[e]},perspective:function(n,t,i,r){var f=1/Math.tan(n*Math.PI/360),u;for(this.proj_mat[0]=f/t,this.proj_mat[1]=0,this.proj_mat[2]=0,this.proj_mat[3]=0,this.proj_mat[4]=0,this.proj_mat[5]=f,this.proj_mat[6]=0,this.proj_mat[7]=0,this.proj_mat[8]=0,this.proj_mat[9]=0,this.proj_mat[10]=(r+i)/(i-r),this.proj_mat[11]=2*r*i/(i-r),this.proj_mat[12]=0,this.proj_mat[13]=0,this.proj_mat[14]=-1,this.proj_mat[15]=0,this.multiply(this.proj_mat),u=0;u<16;u++)this.proj_mat[u]=this.util_mat[u]},setProjMatrix:function(n){for(var t=0;t<16;t++)this.proj_mat[t]=n[t]},viewport:function(n,t,r,u){i.viewport(n,t,r,u);this.view_mat[0]=n;this.view_mat[1]=t;this.view_mat[2]=r;this.view_mat[3]=u},project:function(n,i,r,u,f){return((u==null||u==t)&&(u=this.model_mat),(f==null||f==t)&&(f=this.proj_mat),this.project_in[0]=n*u[0]+i*u[1]+r*u[2]+u[3],this.project_in[1]=n*u[4]+i*u[5]+r*u[6]+u[7],this.project_in[2]=n*u[8]+i*u[9]+r*u[10]+u[11],this.project_in[3]=n*u[12]+i*u[13]+r*u[14]+u[15],this.project_out[0]=this.project_in[0]*f[0]+this.project_in[1]*f[1]+this.project_in[2]*f[2]+this.project_in[3]*f[3],this.project_out[1]=this.project_in[0]*f[4]+this.project_in[1]*f[5]+this.project_in[2]*f[6]+this.project_in[3]*f[7],this.project_out[2]=this.project_in[0]*f[8]+this.project_in[1]*f[9]+this.project_in[2]*f[10]+this.project_in[3]*f[11],this.project_out[3]=this.project_in[0]*f[12]+this.project_in[1]*f[13]+this.project_in[2]*f[14]+this.project_in[3]*f[15],this.project_out[3]==0)?!1:(this.project_x=(this.project_out[0]/this.project_out[3]+1)/2*this.view_mat[2]+this.view_mat[0],this.project_y=(this.project_out[1]/this.project_out[3]+1)/2*this.view_mat[3]+this.view_mat[1],this.project_z=(this.project_out[2]/this.project_out[3]+1)/2,!0)},unProject:function(n,i,r,u,f){return((u==null||u==t)&&(u=this.model_mat),(f==null||f==t)&&(f=this.proj_mat),this.set(f),this.multiply(u),this.invert(),this.project_in[0]=(n-this.view_mat[0])*2/this.view_mat[2]-1,this.project_in[1]=(i-this.view_mat[1])*2/this.view_mat[3]-1,this.project_in[2]=r*2-1,this.project_out[0]=this.project_in[0]*this.util_mat[0]+this.project_in[1]*this.util_mat[1]+this.project_in[2]*this.util_mat[2]+this.util_mat[3],this.project_out[1]=this.project_in[0]*this.util_mat[4]+this.project_in[1]*this.util_mat[5]+this.project_in[2]*this.util_mat[6]+this.util_mat[7],this.project_out[2]=this.project_in[0]*this.util_mat[8]+this.project_in[1]*this.util_mat[9]+this.project_in[2]*this.util_mat[10]+this.util_mat[11],this.project_out[3]=this.project_in[0]*this.util_mat[12]+this.project_in[1]*this.util_mat[13]+this.project_in[2]*this.util_mat[14]+this.util_mat[15],this.project_out[3]==0)?!1:(this.project_x=this.project_out[0]/this.project_out[3],this.project_y=this.project_out[1]/this.project_out[3],this.project_z=this.project_out[2]/this.project_out[3],!0)},transX:function(){return this.trans_x},transY:function(){return this.trans_y},transZ:function(){return this.trans_z},crossX:function(){return this.cross_x},crossY:function(){return this.cross_y},crossZ:function(){return this.cross_z},normalizeX:function(){return this.normalize_x},normalizeY:function(){return this.normalize_y},normalizeZ:function(){return this.normalize_z},reflectX:function(){return this.reflect_x},reflectY:function(){return this.reflect_y},reflectZ:function(){return this.reflect_z},coordX:function(n){return this.coord_x[n]},coordY:function(n){return this.coord_y[n]},coordZ:function(n){return this.coord_z[n]},normalX:function(){return this.normal_x},normalY:function(){return this.normal_y},normalZ:function(){return this.normal_z},centerX:function(){return this.center_x},centerY:function(){return this.center_y},centerZ:function(){return this.center_z},hitX:function(){return this.hit_x},hitY:function(){return this.hit_y},hitZ:function(){return this.hit_z},positionX:function(){return this.position_x},positionY:function(){return this.position_y},positionZ:function(){return this.position_z},projectX:function(){return this.project_x},projectY:function(){return this.project_y},projectZ:function(){return this.project_z}};n._GLDrawPrimitive=e;n._GLDraw=w;n.canUseWebGL=ct;n.setCurrent3D=lt;n.getCurrent3D=a;n.getCurrentContext3D=at;n.setCanvas3DSize=vt;n.createShaderProgram=d;n._GLModel=v;n._GLModelData=o;n.createGLModel=yt;n._GLPrimitive=s;n._GLShader=g;n._GLSprite=nt;n._GLTexture=tt;n._GLTriangle=it;n._GLUtility=y;n._GLPRIMITIVE_TYPE_MODEL=0;n._GLPRIMITIVE_TYPE_SPRITE=1})(window)